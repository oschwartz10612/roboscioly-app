<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Admin</title>
  <% include ../partials/head %>
  <style>
  .cell {
    max-width: 300px; /* tweak me please */
    white-space : nowrap;
    overflow : hidden;
  }
  </style>
  <link href="/css/tabulator.min.css" rel="stylesheet">
  <script type="text/javascript" src="/js/tabulator.min.js"></script>
  <script type="text/javascript" src="http://oss.sheetjs.com/js-xlsx/xlsx.full.min.js"></script>


</head>

<body>
  <% include ../partials/navbar %>

  <div class="container">
    <div class="alert alert-success collapse" role="alert" id="sucsess">
        Successfully saved data!
</div>

    <div class="alert alert-danger collapse" role="alert" id="error">
        There was an error!
    </div>

    <h3>Team Apps Submmissions:</h3>
    <hr>

    <form class="form-inline mb-4">
      <div class="form-group">
        <label for="filter-field">Column: </label>
        <select type="dropdown" name="field" id="filter-field" class="form-control ml-2" placeholder=""></select>
      </div>
      <div class="form-group ml-3">
        <label for="filter-type">Filter:</label>
        <select type="dropdown" name="filter-type" id="filter-type" class="form-control ml-2" placeholder="">
          <option value="=">=</option>
          <option value="<"><</option>
          <option value="<="><=</option>
          <option value=">">></option>
          <option value=">=">>=</option>
          <option value="!=">!=</option>
          <option value="like">like</option>
        </select>
      </div>
      <div class="form-group ml-3">
        <label for="filter-value">Filter Value:</label>
        <input type="text" name="filter-value" id="filter-value" class="form-control ml-2" placeholder="">
      </div>
      <button class="btn btn-primary" id="filter-clear">Clear</button>
    </form>

    <div id="team-table"></div>
    <div id="team-table-textarea"></div>

    <button id="download-csv" class="btn btn-primary mt-4">Download CSV</button>
    <button id="show-text" class="btn btn-danger mt-4">Show text</button>

    <br><hr><br>

    <h3>Teachers:</h3>
    <hr>
    <button class="btn btn-success mb-4" id="add-row">Add Teacher</button>
    <div id="teacher-table"></div>

    <br><br>

    <h3>Settings:</h3>
    <hr>
    <p>Application State:</p>
    <input type="button" value="Close Application" class="btn btn-danger" onClick="closeApp()">
    <input type="button" value="Open Application" class="btn btn-success" onClick="openApp()">

    <hr>

    <p>Collect email on index page:</p>
    <input type="button" value="Close Collect Email Dialog" class="btn btn-danger" onClick="closeCollectEmail()">
    <input type="button" value="Open Collect Email Dialog" class="btn btn-success" onClick="openCollectEmail()">

    <footer class="container">
    <hr>
    <p>&copy; Robinson Science Olympiad 2019-2020</p>
  </footer>
</body>
</html>

<script>

  function closeApp() {
    $.get( "/admin/api/closeApp", function( data ) {
      if (data == 'done') {
        $('#sucsess').show();
           $(".alert").delay(4000).slideUp(200, function() {
              $(this).hide();
        });
      }
    });
  }

  function openApp() {
    $.get( "/admin/api/openApp", function( data ) {
      if (data == 'done') {
        $('#sucsess').show();
           $(".alert").delay(4000).slideUp(200, function() {
              $(this).hide();
        });
      }
    });
  }

    function closeCollectEmail() {
    $.get( "/admin/api/closeCollectEmail", function( data ) {
      if (data == 'done') {
        $('#sucsess').show();
           $(".alert").delay(4000).slideUp(200, function() {
              $(this).hide();
        });
      }
    });
  }

  function openCollectEmail() {
    $.get( "/admin/api/openCollectEmail", function( data ) {
      if (data == 'done') {
        $('#sucsess').show();
           $(".alert").delay(4000).slideUp(200, function() {
              $(this).hide();
        });
      }
    });
  }

  let textareas = ["textarea","textarea1","textarea2","textarea3","textarea4","textarea5","textarea6","textarea7","textarea_rec"];
  $.ajax({
    url: "/admin/api/getcolumns",
    cache: false,
    success: function(result) {
      let rawColumns = [];
      let columns = [];
      for (let i = 0; i < result.length; i++) {
        const element = result[i];
        rawColumns.push(element.column_name);
      }
      for (let i = 0; i < rawColumns.length; i++) {
        const element = rawColumns[i];
        if (element.includes("textarea")) {
          columns.push({
            title: element,
            field: element,
            width: 200,
            editor:"textarea"
          });
        } else {
          if(element == 'user_id') {
            columns.push({
              title: element,
              field: element
            }); 
          } else {
            columns.push({
              title: element,
              field: element,
              editor:"input"
            }); 
          }
        }
      }
      buildTable(columns, rawColumns);
    }
  });

  function buildTable(columns, rawColumns) {
    let dropdown = $('#filter-field');
    for (let i = 0; i < rawColumns.length; i++) {
      const element = rawColumns[i];
      dropdown.append($('<option></option>').val(element).html(element));
    }
    
    var table = new Tabulator("#team-table", {
        ajaxURL:"/admin/api/alldata", 
        height:"800px",
        pagination:"local",
        layout:"fitDataFill",
        paginationSize:20,
        paginationSizeSelector:[20, 30, 40, 50],
        tooltips:true,
        columns: columns,
        cellEdited:function(cell){
         // This callback is called any time a cell is edited.

         $.ajax({
           url: "/admin/api/update_sql",
           data: cell.getRow().getData(),
           type: "post",
           success: function(response, textStatus, xhr){
            $('#sucsess').show();
              $(".alert").delay(4000).slideUp(200, function() {
                  $(this).hide();
            });
           },
           error: function(XMLHttpRequest, textStatus, error){
            $('#error').show();
              $(".alert").delay(4000).slideUp(200, function() {
                  $(this).hide();
            });
           }
         })

       }
    });
    $("#show-text").click(function(){
    let columns = [];
    let textareas = ["textarea","textarea1","textarea2","textarea3","textarea4","textarea5","textarea6","textarea7","textarea_rec"];
    for (let i = 0; i < rawColumns.length; i++) {
      const element = rawColumns[i];
      if (element.includes("textarea")) {
        columns.push({
          title: element,
          field: element,
          width: 500,
          formatter: "textarea"
        });
      } else {
        columns.push({
          title: element,
          field: element
        }); 
      }
    }
    $("#team-table").remove();
    var newTable = new Tabulator("#team-table-textarea", {
      ajaxURL:"/admin/api/alldata", 
      height:"1200px",
      pagination:"local",
      layout:"fitDataFill",
      paginationSize:20,
      paginationSizeSelector:[20, 30, 40, 50],
      columns: columns
    });
    $("#show-text").remove();
  });

  $("#download-csv").click(function(){
    table.download("csv", "data.csv");
  });

  //Update filters on value change
  $("#filter-field, #filter-type").change(updateFilter);
  $("#filter-value").keyup(updateFilter);

  //Clear filters on "Clear Filters" button click
  $("#filter-clear").click(function(){
      $("#filter-field").val("");
      $("#filter-type").val("=");
      $("#filter-value").val("");

      table.clearFilter();
  });
    //Trigger setFilter function with correct parameters
  function updateFilter() {

      var filter = $("#filter-field").val() == "function" ? customFilter : $("#filter-field").val();

      if($("#filter-field").val() == "function" ){
          $("#filter-type").prop("disabled", true);
          $("#filter-value").prop("disabled", true);
      }else{
          $("#filter-type").prop("disabled", false);
          $("#filter-value").prop("disabled", false);
      }

      table.setFilter(filter, $("#filter-type").val(), $("#filter-value").val());
      
  }
  }

  var teacher_columns = [{title: "ID", field: "id"}, {title: "Email", field: "email", editor:"input"}, {title: "Name", field: "name", editor:"input"}, {title: "Department", field: "department", editor:"select", editorParams:{"science":"science", "math":"math"}}];

  var teachers = new Tabulator("#teacher-table", {
        ajaxURL:"/admin/api/teacher_data", 
        height:"800px",
        pagination:"local",
        layout:"fitDataFill",
        paginationSize:20,
        paginationSizeSelector:[20, 30, 40, 50],
        tooltips:true,
        columns: teacher_columns,
        cellEdited:function(cell){
         // This callback is called any time a cell is edited.

         $.ajax({
           url: "/admin/api/update_sql_teachers",
           data: cell.getRow().getData(),
           type: "post",
           success: function(response, textStatus, xhr){
            $('#sucsess').show();
              $(".alert").delay(4000).slideUp(200, function() {
                  $(this).hide();
            });
           },
           error: function(XMLHttpRequest, textStatus, error){
            $('#error').show();
              $(".alert").delay(4000).slideUp(200, function() {
                  $(this).hide();
            });
           }
         })

       }
    });
    $("#add-row").click(function(){
    teachers.addRow({id: "new"});
    });
</script>
